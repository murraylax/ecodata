---
title: "Getting Started with the *ecodata* Package"
output: 
  rmdformats::readthedown:
    thumbnails: false   # Optional: Display thumbnails for sections
    lightbox: true     # Optional: Use lightbox effect for images
    number_sections: true  # Number the sections and reflect them in the TOC
css: custom-readthedown.css
author: 
  - name: "James M. Murray"
    affiliation: '<a href="https://www.uwlax.edu/profile/jmurray/" target=_"blank" class="affiliation">University of Wisconsin-La Crosse</a>'
    email: 'jmurray@uwlax.edu'
date: "Created on `r format(Sys.Date(), '%B %d, %Y')`"
    
# output:
#   prettydoc::html_pretty:
#     theme: architect
#     toc: true       # Enable the table of contents
#     toc_depth: 2    # Include up to level-2 headers
# output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{getting-started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  collapse = FALSE,
  comment = "#>",
  fig.width = 7,  # Width of the plots (in inches)
  fig.height = 4,  # Width of the plots (in inches)
  fig.retina = NULL  # Disable retina scaling
)
# library(gt)
library(flextable)
library(htmltools)

cat('
<style>
/* Force fixed layout on flextable */
table {
    table-layout: fixed !important;
    width: 100% !important;
}
td {
    overflow: hidden;  /* Prevent content from overflowing */
    text-overflow: ellipsis;  /* Optional: Add ellipsis for overflowed text */
}
</style>
')

```

# About the Package

This package makes it easy to download and visualize economic data that is publicly available on [FRED](https://fred.stlouisfed.org/) (Federal Researve Economic Data) or [World Bank](https://data.worldbank.org/). This package is a wrapper for three packages: 

  1.  The [`fredr`](https://cran.r-project.org/web/packages/fredr/) package for downloading data from [FRED](https://data.worldbank.org/)
  
  2.  The [`wbstats`](https://cran.r-project.org/web/packages/wbstats/) package for downloading data from [World Bank Data](https://data.worldbank.org/)
  
  3.  The [`ggplot2`](https://ggplot2.tidyverse.org/) package for visualizing data
  
The `ecodata` package is primarily targeted to novice R users and its primary intention to make the easy things easier. Still, experienced R users might find some of the procedures in this package convenient. With just two or three lines of code, you can use the package to download several variables from FRED and/or World Bank and make professional publication-ready plots. The package also provides a unified framework for downloading and plotting data from either source.

This package is not intended to replace `fredr` or `wbstats`. Those packages include a large amount of functionality which is not duplicated in this package. Experienced R programmers that have more than the simplest needs are best served from the underlying packages, `fredr`, `wbstats`, and `ggplot2`.

The package also does not replace browsing the [FRED](https://data.worldbank.org/) and [World Bank Data](https://data.worldbank.org/) websites to explore and interact with data. In fact, the package provides the next step. After browsing and finding data you are interested in, you just need to copy and paste the URL(s) to retrieve the data using the functions in this package.

# Download and Plot your First Variable

This vignette assumes you have already successfully installed the package and set up the FRED API key. Please see the package [README](https://github.com/murraylax/ecodata/blob/main/README.md) for instructions if you have not already completed this step.

## Load libraries

To begin, let us load the [`tidyverse`]() library to wrangle and manipulate the data, and then the `ecodata` package.

```{r}
library(tidyverse)
library(ecodata)
```

## Download the data

Next, let's download a variable from FRED and inspect it. We will download data on real GDP for the United States, which is available on FRED at [https://fred.stlouisfed.org/series/GDPC1](https://fred.stlouisfed.org/series/GDPC1)

```{r}
gdp <- get_ecodata("https://fred.stlouisfed.org/series/GDPC1")
```

Here is a look at the first ten rows of the data set.

```{r, echo = FALSE}
flextable(slice(gdp, 1:10)) |>
  flextable::width(width = 2)
```

## Make a time series plot

You can use the `ggplot_ecodata_ts()` function with a single parameter to make a time series plot the data.

```{r}
ggplot_ecodata_ts(gdp)
```

Notice the default features such as a clean simple plot, large text that is ready for presentations, and the citation of the source of the data in the caption of the figure. These are elements of a `ggplot` that users could choose to change.

You can add a title one of two ways. The first is to pass the optional parameter, `title`:

```{r}
ggplot_ecodata_ts(gdp, title = "Real GDP for the United States")
```

The other is to use the `labs()` function for adding or changing labels, which is provided by the `ggplot2` package. This approach is likely familiar to experienced R users.

```{r}
ggplot_ecodata_ts(gdp) + labs(title = "Real GDP for the United States")
```

You can add NBER recession bars with one of two ways. The simplest is the addition of the optional `title` parameter: 

```{r}
# Include recession bars with a parameter
ggplot_ecodata_ts(gdp, title = "Real GDP for the United States", plot.recessions = TRUE)
```

R users already familiar with `ggplot()` may be more comfortable adding recession bars by adding a `geom_recession()`, a geom that is unique to this package. 
```{r}
# Include recession bars by adding a geom  
ggplot_ecodata_ts(gdp) + 
  labs(title = "Real GDP for the United States") +
  geom_recession()
```

# Multiple Variables

We can pull multiple variable from multiple sources all at once. Let's consider the following variables:

  - Income share held by the lowest 20% of the United States population, from World Bank Data: [https://data.worldbank.org/indicator/SI.DST.FRST.20?locations=US](https://data.worldbank.org/indicator/SI.DST.FRST.20?locations=US)
  
  - Poverty rate in the United States, as a percentage of the population, from World Bank Data: [https://data.worldbank.org/indicator/SI.POV.DDAY?locations=US](https://data.worldbank.org/indicator/SI.POV.DDAY?locations=US)
  
  - Unemployment rate in the United States, from FRED: [https://fred.stlouisfed.org/series/UNRATE](https://fred.stlouisfed.org/series/UNRATE)
  
Some things to make note of that is usually complicated to work with:

  - We have data from multiple sources, using different APIs
  
  - We have mixed frequency data. The data from the World Bank is annual, while the unemployment data on FRED is monthly.
  
The *ecodata* package takes takes of these issues in the background.

## Download the data

We can combine the three data sources together with the base R `c()` function. 

```{r}
my_variables <- c(
  "https://data.worldbank.org/indicator/SI.DST.FRST.20?locations=US",
  "https://data.worldbank.org/indicator/SI.POV.DDAY?locations=US",
  "https://fred.stlouisfed.org/series/UNRATE"
)
```

Next, we'll pass this vector of variables to the `get_ecodata()` function:
```{r}
mydata <- get_ecodata(my_variables)
```

Here is a look at the first twelve rows of the data set.

```{r, echo = FALSE}
flextable(head(mydata, 12)) |>
  flextable::width(width = 2)
```

Notice that the World Bank data is missing (the underlying observations are set to `NA`) for the first several observations. This is because the unemployment rate data is available back to 1956, while the World Bank data is available to 1963. If we look at a slice of more recent data, we see the following:

```{r, echo = FALSE}
flextable(slice(mydata, (nrow(mydata)-40):(nrow(mydata)-29) )) |>
  flextable::width(width = 2)
```

There is one observation over the year for the World Bank data, while there are observations for every month for unemployment data. This is expected.

## Using different variable names

The variable names that the World Bank gives are rather long. It's possible to specify our own variable names in the call to `get_ecodata()`. We will again set up the URLs for the data locations, and specify convenient variable names:

```{r}
my_variables <- c(
  "https://data.worldbank.org/indicator/SI.DST.FRST.20?locations=US",
  "https://data.worldbank.org/indicator/SI.POV.DDAY?locations=US",
  "https://fred.stlouisfed.org/series/UNRATE"
)

variable_names <- c(
  "Income Share of Bottom 20%",
  "Poverty Rate",
  "Unemployent Rate"
)

mydata <- get_ecodata(my_variables, variable_names)
```

Here is a slice of the data from 2021-2022.

```{r, echo = FALSE}
flextable(slice(mydata, (nrow(mydata)-40):(nrow(mydata)-29) )) |>
  flextable::width(width = 2)
```

## Time series and faceted plots

We can make a time series as before. The simplest way is to just call `ggplot_ecodata()`.

```{r, fig.height = 6, warning = FALSE}
ggplot_ecodata_ts(mydata, title = "Unemployment and Poverty in U.S.", plot.recessions = TRUE)
```

Note that each series is given its own color, and a legend appears at the bottom of the plot. The function `ggplot_ecodata_ts()` will allow for up to 7 series to plot in a single graph (but three is usually a good maximum to consider). 

Plotting multiple lines on a single plot is best when the variables are directly comparable. While all three variables are percentages, the percentages for poverty rate, unemployment rate, and income share are not directly comparable. This is probably not the most convenient way to visualize these variables.

We can alternatively make a faceted plot using `ggplot_ecodata_facet()`, following a similar structure as above:

```{r, fig.height = 6, warning = FALSE}
ggplot_ecodata_facet(mydata, 
                     title = "Unemployment and Poverty in U.S.", 
                     ncol = 1, 
                     plot.recessions = TRUE)
```

Note that we specified the multiple plots to appear in a single column, using the optional parameter, `ncol = 1`. 

## Plot only selected variables

With either time series plots or faceted plot, you can choose to only plot a selection of variables, using the `variables` parameter. Below we choose to only plot the two World Bank variables. 

```{r}
ggplot_ecodata_facet(mydata, 
                     variables = c("Income Share of Bottom 20%", "Poverty Rate"),
                     title = "Income and Poverty in U.S.", 
                     ncol = 1, 
                     plot.recessions = TRUE)
```

More experienced R users may be more comfortable using **dplyr** functions to select the data, then passing the selected data to the plot function. Using this strategy, it is necessary to select the `Date` variable, in addition to the variables of interest. The following code accomplishes the same as above:

```{r}
mydata |>
  select(Date, `Income Share of Bottom 20%`, `Poverty Rate`) |>
  ggplot_ecodata_facet(title = "Income and Poverty in the U.S.", ncol = 1, plot.recessions = TRUE)
```

# Multiple Locations

## Multiple States

For state-level variables in FRED, if you find the variable for one state, you can easily download the same variable for all the U.S. states using...

Here is the unemployment rate for California: [https://fred.stlouisfed.org/series/CAUR](https://fred.stlouisfed.org/series/CAUR). The following code downloads the unemployment rate for all 50 states:

```{r}
allstates <- get_ecodata_allstates_fred("https://fred.stlouisfed.org/series/CAUR")
```

We can take a `glimpse()` at the data to verify that we have a column for every U.S. state and the District of Columbia.

```{r}
glimpse(allstates)
```

Be cautious with this approach. The FRED API only allows a limited number of requests for given periods of time, before you have to wait to download again. FRED will return an error or a warning when you have reached this limit. 

# Data Documentation

## Finding suggested citation

You can use `ecodata_cite_table()` to get citation information for an *ecodata* data frame. We get citation information for `mydata` from above as follows:

```{r}
ecodata_cite_table(mydata)
```

## Information about the variables

We can get more thorough information on our variables using `ecodata_description_table()`:

```{r, eval = FALSE}
ecodata_description_table(mydata)
```
```{r, echo = FALSE}
ft <- ecodata_description_table(mydata) 
htmltools::tags$div(
  style = "overflow-x: auto; width: 100%; max-width: 100%;",
  htmltools_value(ft)
)
```

The table includes descriptions provided by FRED or World Bank, and a number of other characteristics including frequency, units, seasonal adjustment status, and source.

